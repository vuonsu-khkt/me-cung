<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharaoh Maze - Lăng Mộ Vĩnh Hằng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; overflow: hidden; background-color: #0d0d0d; 
            font-family: 'Quicksand', sans-serif; display: flex;
            justify-content: center; align-items: center; height: 100vh;
        }
        canvas { 
            border: 6px solid #8b6b3d; image-rendering: pixelated;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); max-width: 95vw; max-height: 95vh;
        }
        .overlay { background: rgba(20, 15, 10, 0.98); border: 2px solid #ffd700; border-radius: 12px; }
        .text-ancient { font-family: 'Cinzel', serif; color: #ffd700; }
        .btn-option { 
            transition: all 0.2s; background: #2a1b12; border: 1px solid #b38b4d; 
            width: 100%; color: white; padding: 14px; border-radius: 8px; 
            margin-bottom: 8px; pointer-events: auto; text-align: left;
        }
        .btn-option:hover { background: #ffd700; color: #1a1a1a; transform: scale(1.02); font-weight: bold; }
        .progress-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #555; margin: 0 5px; }
        .dot-correct { background: #22c55e; border-color: #fff; box-shadow: 0 0 8px #22c55e; }
        .dot-wrong { background: #ef4444; border-color: #fff; box-shadow: 0 0 8px #ef4444; }
        
        /* Hiệu ứng gõ chữ cho Intro */
        .typing {
            overflow: hidden;
            border-right: .15em solid orange;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: .15em;
            animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: orange; } }

        #msg-box { 
            position: absolute; top: 12%; left: 50%; transform: translateX(-50%);
            padding: 15px 35px; background: #ffd700; color: #000; font-weight: 900;
            border-radius: 4px; display: none; z-index: 100; border: 3px double #000;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer" class="absolute inset-0 pointer-events-none">
        
        <!-- MÀN HÌNH CHÀO & INTRO -->
        <div id="start-screen" class="flex flex-col items-center justify-center h-full pointer-events-auto bg-black">
            <div id="intro-content" class="overlay p-12 text-center max-w-2xl shadow-[0_0_100px_rgba(184,134,11,0.2)]">
                <div id="title-part">
                    <h1 class="text-6xl font-bold text-ancient mb-4">ĐẠI MÊ CUNG</h1>
                    <h2 class="text-2xl text-yellow-500 mb-8 uppercase tracking-[0.3em]">Pharaoh's Tomb</h2>
                    <button id="show-intro-btn" class="px-20 py-5 bg-[#ffd700] text-black font-black text-xl rounded-sm hover:bg-yellow-400 transition-all uppercase">Bắt đầu hành trình</button>
                </div>
                
                <div id="story-part" class="hidden text-left space-y-6">
                    <p class="text-yellow-500 font-bold text-xl italic">"Bạn là một nhà thám hiểm tài ba..."</p>
                    <p class="text-gray-300 leading-relaxed">
                        Trong lúc tìm kiếm di tích cổ, bạn đã vô tình rơi vào một hầm ngầm bí mật. 
                        Ánh đuốc leo lét soi rọi những bức tường đầy ký tự lạ lẫm. 
                        Bạn đã lạc vào <span class="text-yellow-500 font-bold">Mê cung của Pharaoh</span> - một lăng mộ gồm 30 tầng đầy cạm bẫy.
                    </p>
                    <p class="text-gray-300">
                        Nhiệm vụ duy nhất của bạn: <span class="text-white font-bold underline">Sống sót và thoát ra khỏi đây</span> bằng cách giải mã những câu đố lịch sử ngàn năm.
                    </p>
                    <div class="pt-6">
                        <button id="start-game-btn" class="w-full py-4 bg-yellow-600 text-white font-bold rounded hover:bg-yellow-500 transition-all">TÔI ĐÃ SẴN SÀNG</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MÀN HÌNH CHIẾN THẮNG CUỐI CÙNG -->
        <div id="win-screen" class="hidden flex flex-col items-center justify-center h-full pointer-events-auto bg-black/90">
            <div class="overlay p-16 text-center max-w-3xl border-double border-8 border-yellow-500 shadow-[0_0_200px_rgba(255,215,0,0.4)]">
                <h1 class="text-7xl font-bold text-ancient mb-6 animate-bounce">VICTORY</h1>
                <h2 class="text-3xl text-yellow-500 mb-10 uppercase tracking-[0.5em]">Huyền Thoại Nhà Thám Hiểm</h2>
                <div class="text-gray-200 text-xl space-y-4 mb-12">
                    <p>Ánh sáng mặt trời cuối cùng cũng rọi xuống...</p>
                    <p>Bạn đã vượt qua <span class="text-yellow-500 font-bold">30 tầng lăng mộ</span> và giải đáp mọi bí ẩn lịch sử.</p>
                    <p class="text-2xl text-white font-black pt-4">BẠN ĐÃ TRỞ THÀNH NGƯỜI TỰ DO!</p>
                </div>
                <button onclick="location.reload()" class="px-12 py-4 bg-white text-black font-black rounded-full hover:bg-yellow-400 transition-all">CHƠI LẠI</button>
            </div>
        </div>

        <!-- HUD -->
        <div id="hud" class="absolute top-8 left-8 hidden">
            <div class="bg-black/90 border-l-4 border-yellow-500 p-5 text-[#ffd700] shadow-2xl rounded-r">
                <div class="text-[10px] font-bold opacity-60 uppercase tracking-widest mb-1">Tiến trình thoát hiểm</div>
                <div class="text-5xl font-black" id="lvl-display">1/30</div>
                <div class="mt-3 text-sm text-white font-bold" id="key-count">Chìa khóa: 0 / 3</div>
            </div>
        </div>

        <!-- Panel câu hỏi -->
        <div id="q-panel" class="hidden absolute inset-0 flex items-center justify-center p-6 bg-black/95 pointer-events-auto">
            <div class="overlay p-10 max-w-2xl w-full text-white">
                <div class="flex justify-between items-center mb-8 border-b border-yellow-900 pb-6">
                    <div>
                        <span class="text-yellow-500 font-bold uppercase block text-xs tracking-widest">Cửa quan trí tuệ</span>
                        <span class="text-2xl font-black" id="q-header">...</span>
                    </div>
                    <div class="flex" id="progress-dots">
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                    </div>
                </div>
                <h2 id="q-text" class="text-3xl font-bold mb-10 text-center leading-relaxed italic">...</h2>
                <div id="opts" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>

        <div id="msg-box"></div>
    </div>

    <script>
        // --- DỮ LIỆU CÂU HỎI ---
        const QUESTION_POOL = [
            { q: "Vị vua nào dời đô từ Hoa Lư về Thăng Long năm 1010?", a: "Lý Thái Tổ", o: ["Lý Thái Tổ", "Lý Thánh Tông", "Lê Lợi", "Gia Long"] },
            { q: "Trận Bạch Đằng năm 938 đánh tan quân Nam Hán do ai lãnh đạo?", a: "Ngô Quyền", o: ["Ngô Quyền", "Lê Hoàn", "Trần Hưng Đạo", "Đinh Bộ Lĩnh"] },
            { q: "Ai là người lãnh đạo cuộc khởi nghĩa Lam Sơn?", a: "Lê Lợi", o: ["Lê Lợi", "Nguyễn Trãi", "Nguyễn Huệ", "Trần Quý Khoáng"] },
            { q: "Quốc hiệu đầu tiên của nước ta là gì?", a: "Văn Lang", o: ["Văn Lang", "Âu Lạc", "Đại Việt", "Đại Cồ Việt"] },
            { q: "Vị anh hùng dân tộc nào được mệnh danh là 'Bình Tây Đại Nguyên Soái'?", a: "Trương Định", o: ["Trương Định", "Nguyễn Trung Trực", "Thủ Khoa Huân", "Phan Đình Phùng"] },
            { q: "Trận đánh nào kết thúc cuộc kháng chiến chống Mỹ?", a: "Chiến dịch Hồ Chí Minh", o: ["Chiến dịch Hồ Chí Minh", "Điện Biên Phủ", "Trận Ấp Bắc", "Mậu Thân 1968"] },
            { q: "Ai là người cắm cờ trên dinh Độc Lập ngày 30/4/1975?", a: "Bùi Quang Thận", o: ["Bùi Quang Thận", "Phạm Tuân", "Nguyễn Thành Trung", "Võ Nguyên Giáp"] },
            { q: "Triều đại nào có thời gian tồn tại lâu nhất trong lịch sử Việt Nam?", a: "Nhà Hậu Lê", o: ["Nhà Hậu Lê", "Nhà Lý", "Nhà Trần", "Nhà Nguyễn"] },
            { q: "Cuộc khởi nghĩa Hai Bà Trưng diễn ra vào năm nào?", a: "Năm 40", o: ["Năm 40", "Năm 43", "Năm 938", "Năm 248"] },
            { q: "Vị trạng nguyên trẻ nhất lịch sử Việt Nam là ai?", a: "Nguyễn Hiền", o: ["Nguyễn Hiền", "Lê Văn Hưu", "Mạc Đĩnh Chi", "Lương Thế Vinh"] },
            { q: "Tác giả của 'Hịch Tướng Sĩ' là ai?", a: "Trần Hưng Đạo", o: ["Trần Hưng Đạo", "Trần Quang Khải", "Trần Quốc Toản", "Phạm Ngũ Lão"] },
            { q: "Ai là người được dân gian gọi là 'Ông Trạng Lường'?", a: "Lương Thế Vinh", o: ["Lương Thế Vinh", "Nguyễn Hiền", "Mạc Đĩnh Chi", "Phạm Trấn"] },
            { q: "Chiến thắng Điện Biên Phủ diễn ra vào năm nào?", a: "1954", o: ["1954", "1945", "1975", "1968"] },
            { q: "Thành Cổ Loa gắn liền với vị vua nào?", a: "An Dương Vương", o: ["An Dương Vương", "Hùng Vương", "Triệu Đà", "Lê Hoàn"] },
            { q: "Napoleon Bonaparte là hoàng đế của quốc gia nào?", a: "Pháp", o: ["Pháp", "Anh", "Đức", "Ý"] },
            { q: "Thế chiến thứ hai kết thúc vào năm nào?", a: "1945", o: ["1945", "1918", "1954", "1939"] },
            { q: "Pharaoh nổi tiếng nhất với lăng mộ nguyên vẹn được tìm thấy năm 1922?", a: "Tutankhamun", o: ["Tutankhamun", "Ramses II", "Khufu", "Akhenaten"] },
            { q: "Ai là tác giả của bản Tuyên ngôn Độc lập nước Việt Nam Dân chủ Cộng hòa?", a: "Hồ Chí Minh", o: ["Hồ Chí Minh", "Võ Nguyên Giáp", "Phạm Văn Đồng", "Trường Chinh"] },
            { q: "Đại hội Đảng lần thứ nhất diễn ra ở đâu?", a: "Ma Cao", o: ["Ma Cao", "Hà Nội", "Cao Bằng", "Pắc Bó"] },
            { q: "Bình Ngô Đại Cáo được viết sau khi đánh thắng quân nào?", a: "Quân Minh", o: ["Quân Minh", "Quân Thanh", "Quân Nguyên", "Quân Xiêm"] },
            { q: "Chiến thắng Rạch Gầm - Xoài Mút là chiến công của ai?", a: "Nguyễn Huệ", o: ["Nguyễn Huệ", "Nguyễn Ánh", "Lê Lợi", "Trần Hưng Đạo"] },
            { q: "Vị vua nào lấy niên hiệu là Quang Trung?", a: "Nguyễn Huệ", o: ["Nguyễn Huệ", "Nguyễn Nhạc", "Nguyễn Lữ", "Nguyễn Ánh"] },
            { q: "Ai được mệnh danh là 'Trạng Trình'?", a: "Nguyễn Bỉnh Khiêm", o: ["Nguyễn Bỉnh Khiêm", "Phùng Khắc Khoan", "Nguyễn Hiền", "Lương Thế Vinh"] },
            { q: "Thành phố Sài Gòn chính thức mang tên TP. Hồ Chí Minh vào năm nào?", a: "1976", o: ["1976", "1975", "1980", "1945"] },
            { q: "Ai là tác giả của bài thơ 'Thần' Nam Quốc Sơn Hà?", a: "Lý Thường Kiệt", o: ["Lý Thường Kiệt", "Lý Thái Tổ", "Trần Hưng Đạo", "Nguyễn Trãi"] },
            { q: "Kinh đô của nhà Trần nằm ở đâu?", a: "Thăng Long", o: ["Thăng Long", "Hoa Lư", "Phú Xuân", "Cổ Loa"] },
            { q: "Ai là vị nữ vương duy nhất trong lịch sử phong kiến Việt Nam?", a: "Lý Chiêu Hoàng", o: ["Lý Chiêu Hoàng", "Nguyên phi Ỷ Lan", "Thái hậu Dương Vân Nga", "Bà Triệu"] },
            { q: "Vua nào thực hiện chính sách 'Bế quan tỏa cảng' khắt khe nhất?", a: "Minh Mạng", o: ["Minh Mạng", "Gia Long", "Tự Đức", "Thiệu Trị"] },
            { q: "Phong trào Cần Vương do ai khởi xướng?", a: "Hàm Nghi và Tôn Thất Thuyết", o: ["Hàm Nghi và Tôn Thất Thuyết", "Phan Bội Châu", "Phan Châu Trinh", "Hoàng Hoa Thám"] },
            { q: "Đội Việt Nam Tuyên truyền Giải phóng quân thành lập ngày nào?", a: "22/12/1944", o: ["22/12/1944", "19/08/1945", "02/09/1945", "03/02/1930"] },
            { q: "Tên cũ của Kim Tự Tháp lớn nhất thế giới là gì?", a: "Khufu", o: ["Khufu", "Khafre", "Menkaure", "Djoser"] },
            { q: "Nữ vương nào nổi tiếng của Ai Cập cổ đại?", a: "Cleopatra", o: ["Cleopatra", "Nefertiti", "Hatshepsut", "Isis"] },
            { q: "Kênh đào Suez nối biển nào với nhau?", a: "Địa Trung Hải và Biển Đỏ", o: ["Địa Trung Hải và Biển Đỏ", "Đại Tây Dương và Thái Bình Dương", "Biển Đen và Biển Đỏ", "Biển Baltic và Biển Bắc"] },
            { q: "Ai là người tìm ra Châu Mỹ?", a: "Christopher Columbus", o: ["Christopher Columbus", "Vasco da Gama", "Magellan", "Marco Polo"] },
            { q: "Lãnh đạo cuộc Cách mạng tháng Mười Nga là ai?", a: "Lenin", o: ["Lenin", "Stalin", "Marx", "Engels"] },
            { q: "Văn Miếu - Quốc Tử Giám được xây dựng dưới triều vua nào?", a: "Lý Thánh Tông", o: ["Lý Thánh Tông", "Lý Nhân Tông", "Lý Thái Tổ", "Lý Anh Tông"] },
            { q: "Bác Hồ ra đi tìm đường cứu nước từ bến cảng nào?", a: "Nhà Rồng", o: ["Nhà Rồng", "Hải Phòng", "Đà Nẵng", "Cần Thơ"] },
            { q: "Sông nào được coi là biên giới chia cắt Đàng Trong và Đàng Ngoài?", a: "Sông Gianh", o: ["Sông Gianh", "Sông Bến Hải", "Sông Hồng", "Sông Hương"] },
            { q: "Vị anh hùng nào lấy thân mình lấp lỗ châu mai?", a: "Phan Đình Giót", o: ["Phan Đình Giót", "Tô Vĩnh Diện", "Bế Văn Đàn", "Lý Tự Trọng"] },
            { q: "Cuộc khởi nghĩa Yên Thế do ai lãnh đạo?", a: "Hoàng Hoa Thám", o: ["Hoàng Hoa Thám", "Phan Đình Phùng", "Nguyễn Thiện Thuật", "Đinh Công Tráng"] },
            { q: "Thương cảng nổi tiếng nhất nước ta thế kỷ XVII là gì?", a: "Hội An", o: ["Hội An", "Vân Đồn", "Phố Hiến", "Thăng Long"] },
            { q: "Nhà nước đầu tiên của nước ta có tên là gì?", a: "Văn Lang", o: ["Văn Lang", "Âu Lạc", "Đại Việt", "Vạn Xuân"] },
            { q: "Ai là người đề ra chủ trương 'Duy Tân'?", a: "Phan Châu Trinh", o: ["Phan Châu Trinh", "Phan Bội Châu", "Huỳnh Thúc Kháng", "Trần Quý Cáp"] },
            { q: "Chiến thắng 'Điện Biên Phủ trên không' diễn ra vào năm nào?", a: "1972", o: ["1972", "1968", "1975", "1954"] },
            { q: "Vua nào có nhiều con nhất lịch sử Việt Nam?", a: "Minh Mạng", o: ["Minh Mạng", "Gia Long", "Tự Đức", "Khải Định"] },
            { q: "Ai là người dẹp loạn 12 sứ quân?", a: "Đinh Bộ Lĩnh", o: ["Đinh Bộ Lĩnh", "Lê Hoàn", "Ngô Quyền", "Lý Thái Tổ"] },
            { q: "Tượng Nhân sư ở Ai Cập có đầu người và thân của con gì?", a: "Sư tử", o: ["Sư tử", "Hổ", "Báo", "Chó sói"] },
            { q: "Thời gian diễn ra Chiến tranh Lạnh là khi nào?", a: "1947 - 1991", o: ["1947 - 1991", "1914 - 1918", "1939 - 1945", "1955 - 1975"] },
            { q: "Ai là tổng thống đầu tiên của nước Mỹ?", a: "George Washington", o: ["George Washington", "Abraham Lincoln", "Thomas Jefferson", "John Adams"] },
            { q: "Nhà bác học nào phát minh ra bóng đèn điện?", a: "Thomas Edison", o: ["Thomas Edison", "Nikola Tesla", "Albert Einstein", "Isaac Newton"] }
        ];

        // --- QUẢN LÝ ÂM THANH ---
        let audioCtx;
        let ambientSource;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playBeep(f, d, v=0.1) {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function playFootstep() {
            if(!audioCtx) return;
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(400, audioCtx.currentTime);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start();
        }

        function startAmbientMusic() {
            if(!audioCtx || ambientSource) return;
            const phrygianScale = [110, 116.54, 130.81, 146.83, 164.81, 174.61, 196.00];
            const scheduleMusic = () => {
                let time = audioCtx.currentTime;
                for(let i=0; i<5; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(phrygianScale[Math.floor(Math.random()*phrygianScale.length)]/2, time + i*4);
                    gain.gain.setValueAtTime(0, time+i*4);
                    gain.gain.linearRampToValueAtTime(0.03, time+i*4+1);
                    gain.gain.linearRampToValueAtTime(0, time+i*4+6);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(time+i*4); osc.stop(time+i*4+6);
                }
                setTimeout(scheduleMusic, 20000);
            };
            scheduleMusic();
            ambientSource = true;
        }

        // --- LOGIC GAME ---
        let availableQuestions = [...QUESTION_POOL];
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let maze = [];
        let mazeWidth, mazeHeight, tileSize;
        let player = { x: 1, y: 1, animX: 1, animY: 1, bob: 0 };
        let artifacts = [];
        let currentLvl = 1;
        let gameRunning = false;
        let currentQuiz = null;
        let keysPressed = {};
        let moveTimer = 0;

        function getUniqueQuestions(count) {
            if (availableQuestions.length < count) availableQuestions = [...QUESTION_POOL];
            let selected = [];
            for (let i = 0; i < count; i++) {
                let idx = Math.floor(Math.random() * availableQuestions.length);
                selected.push(availableQuestions[idx]);
                availableQuestions.splice(idx, 1);
            }
            return selected;
        }

        function generateMaze(w, h) {
            let m = Array(h).fill().map(() => Array(w).fill(1));
            function walk(x, y) {
                m[y][x] = 0;
                let ds = [[0,-2],[0,2],[-2,0],[2,0]].sort(()=>Math.random()-0.5);
                for(let [dx, dy] of ds) {
                    let nx = x+dx, ny = y+dy;
                    if(nx>0 && nx<w-1 && ny>0 && ny<h-1 && m[ny][nx]===1) {
                        m[y+dy/2][x+dx/2] = 0; walk(nx, ny);
                    }
                }
            }
            walk(1, 1); return m;
        }

        function initLevel() {
            if(currentLvl > 30) { 
                gameRunning = false;
                document.getElementById('hud').style.display = 'none';
                document.getElementById('win-screen').style.display = 'flex';
                playBeep(880, 1.5, 0.3);
                return; 
            }
            
            mazeWidth = 11 + (Math.floor((currentLvl - 1) / 2) * 2);
            mazeHeight = mazeWidth;
            tileSize = Math.min(45, (window.innerHeight * 0.8) / mazeHeight);
            canvas.width = mazeWidth * tileSize;
            canvas.height = mazeHeight * tileSize;

            maze = generateMaze(mazeWidth, mazeHeight);
            player.x = 1; player.y = 1;
            player.animX = 1; player.animY = 1;
            
            artifacts = [];
            for(let i=0; i<3; i++) {
                let rx, ry;
                do {
                    rx = Math.floor(Math.random() * mazeWidth);
                    ry = Math.floor(Math.random() * mazeHeight);
                } while(maze[ry][rx] !== 0 || (rx===1 && ry===1) || artifacts.some(a=>a.x===rx && a.y===ry));
                artifacts.push({ x: rx, y: ry, collected: false, questions: getUniqueQuestions(3) });
            }
            document.getElementById('lvl-display').innerText = `${currentLvl}/30`;
            updateKeyStatus();
            notify(`TẦNG ${currentLvl}: HÃY TÌM LỐI RA`);
            playBeep(440, 0.4);
        }

        function updateKeyStatus() {
            let count = artifacts.filter(a => a.collected).length;
            document.getElementById('key-count').innerText = `Chìa khóa: ${count} / 3`;
        }

        function notify(m) {
            const b = document.getElementById('msg-box');
            b.innerText = m; b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 3000);
        }

        function handleMovement(dt) {
            if(!gameRunning || currentQuiz) return;
            moveTimer += dt;
            if(moveTimer > 110) { 
                let nx = player.x, ny = player.y;
                if(keysPressed['w'] || keysPressed['arrowup']) ny--;
                else if(keysPressed['s'] || keysPressed['arrowdown']) ny++;
                else if(keysPressed['a'] || keysPressed['arrowleft']) nx--;
                else if(keysPressed['d'] || keysPressed['arrowright']) nx++;
                if((nx !== player.x || ny !== player.y) && maze[ny] && maze[ny][nx] === 0) {
                    player.x = nx; player.y = ny; moveTimer = 0;
                    playFootstep();
                    checkCollision();
                }
            }
            player.animX += (player.x - player.animX) * 0.3;
            player.animY += (player.y - player.animY) * 0.3;
            if(Math.abs(player.x - player.animX) > 0.01) player.bob += 0.5;
            else player.bob *= 0.8;
        }

        function checkCollision() {
            artifacts.forEach((art, idx) => {
                if(!art.collected && art.x === player.x && art.y === player.y) startQuiz(idx);
            });
        }

        function startQuiz(idx) {
            currentQuiz = { artIdx: idx, step: 0, correct: 0, data: artifacts[idx].questions };
            document.getElementById('q-panel').style.display = 'flex';
            updateQuizUI();
        }

        function updateQuizUI() {
            const q = currentQuiz.data[currentQuiz.step];
            document.getElementById('q-header').innerText = `Thử thách ${currentQuiz.step + 1}/3`;
            document.getElementById('q-text').innerText = q.q;
            const optCont = document.getElementById('opts');
            optCont.innerHTML = '';
            [...q.o].sort(()=>Math.random()-0.5).forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-option font-bold text-lg';
                b.innerText = o;
                b.onclick = () => {
                    const isCorrect = (o === q.a);
                    const dots = document.querySelectorAll('.progress-dot');
                    if(isCorrect) { currentQuiz.correct++; dots[currentQuiz.step].className = 'progress-dot dot-correct'; playBeep(880, 0.1); }
                    else { dots[currentQuiz.step].className = 'progress-dot dot-wrong'; playBeep(220, 0.3); }
                    currentQuiz.step++;
                    if(currentQuiz.step < 3) setTimeout(updateQuizUI, 500);
                    else setTimeout(endQuiz, 600);
                };
                optCont.appendChild(b);
            });
        }

        function endQuiz() {
            if(currentQuiz.correct >= 2) {
                artifacts[currentQuiz.artIdx].collected = true;
                notify(`BẠN ĐÃ CÓ CHÌA KHÓA! (${currentQuiz.correct}/3)`);
                playBeep(1100, 0.5);
                updateKeyStatus();
                if(artifacts.every(a => a.collected)) {
                    currentLvl++;
                    setTimeout(initLevel, 1200);
                }
            } else {
                notify(`THẤT BẠI! Lời nguyền đưa bạn về khởi điểm.`);
                player.x = 1; player.y = 1; 
                playBeep(100, 0.5, 0.2);
            }
            document.getElementById('q-panel').style.display = 'none';
            document.querySelectorAll('.progress-dot').forEach(d => d.className = 'progress-dot');
            currentQuiz = null;
        }

        function draw() {
            ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for(let y=0; y<mazeHeight; y++) {
                for(let x=0; x<mazeWidth; x++) {
                    if(maze[y][x] === 1) {
                        ctx.fillStyle = '#221a12'; ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
                        ctx.strokeStyle = '#3d2b1f'; ctx.lineWidth = 1; ctx.strokeRect(x*tileSize+2, y*tileSize+2, tileSize-4, tileSize-4);
                    } else {
                        ctx.fillStyle = '#1a140f'; ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
                    }
                }
            }
            artifacts.forEach(art => {
                if(!art.collected) {
                    let cx = art.x*tileSize+tileSize/2, cy = art.y*tileSize+tileSize/2;
                    ctx.shadowBlur = 20; ctx.shadowColor = "gold"; ctx.fillStyle = '#ffd700';
                    ctx.beginPath(); ctx.arc(cx, cy + Math.sin(Date.now()/150)*5, tileSize/3.5, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
            let px = player.animX*tileSize+tileSize/2, py = player.animY*tileSize+tileSize/2;
            let bob = Math.abs(Math.sin(player.bob))* -tileSize/6;
            const pGrad = ctx.createRadialGradient(px, py+bob, 2, px, py+bob, tileSize/1.5);
            pGrad.addColorStop(0, '#ffd700'); pGrad.addColorStop(1, '#e67e22');
            ctx.fillStyle = pGrad; ctx.beginPath(); ctx.arc(px, py+bob, tileSize/2.2, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(px-tileSize/8, py+bob-2, 3, 0, Math.PI*2); ctx.arc(px+tileSize/8, py+bob-2, 3, 0, Math.PI*2); ctx.fill();
            const grad = ctx.createRadialGradient(px, py+bob, 20, px, py+bob, tileSize * 4);
            grad.addColorStop(0, 'rgba(255, 200, 100, 0.1)'); grad.addColorStop(0.5, 'rgba(0,0,0,0.4)'); grad.addColorStop(1, 'rgba(0,0,0,0.95)');
            ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width, canvas.height);
        }

        let last = 0;
        function gameLoop(ts) {
            handleMovement(ts - last);
            draw();
            last = ts;
            if(gameRunning) requestAnimationFrame(gameLoop);
        }

        // --- SỰ KIỆN GIAO DIỆN ---
        window.onload = function() {
            document.getElementById('show-intro-btn').onclick = () => {
                initAudio();
                document.getElementById('title-part').classList.add('hidden');
                document.getElementById('story-part').classList.remove('hidden');
                playBeep(330, 0.3);
            };

            document.getElementById('start-game-btn').onclick = () => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                startAmbientMusic();
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                gameRunning = true;
                initLevel();
                requestAnimationFrame(gameLoop);
            };

            window.addEventListener('keydown', e => keysPressed[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', e => keysPressed[e.key.toLowerCase()] = false);
        };
    </script>
</body>
</html>
